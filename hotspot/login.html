<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="expires" content="-1" />
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate, max-age=0" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Internet hotspot - Log in</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <!-- Add hidden fields for MikroTik CHAP values -->
    <input type="hidden" id="chap-id" value="$(chap-id)" />
    <input type="hidden" id="chap-challenge" value="$(chap-challenge)" />
    <script src="md5.js"></script>
    <script>
        // Get organization ID from URL parameter or set a default
        function getOrgId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('org') || 'cmfc3c2fa0001kwyk82la4cw7';
        }

        // Get base API URL
        function getApiUrl() {
            return 'https://ispinnacle.co.ke';
        }

        // Get current page URL for debugging
        function getCurrentUrl() {
            return window.location.href;
        }

        // Get MikroTik variables
        function getMikroTikVar(varName) {
            const form = document.getElementById('mikrotik-vars-form');
            if (form) {
                const input = form.querySelector(`input[name="${varName}"]`);
                return input ? input.value : `$(${varName})`;
            }
            return `$(${varName})`;
        }

        // Check if we're in MikroTik hotspot environment
        function isMikroTikHotspot() {
            const chapId = getMikroTikVar('chap-id');
            const linkOrig = getMikroTikVar('link-orig');
            return chapId !== '$(chap-id)' || linkOrig !== '$(link-orig)';
        }

        // Compute CHAP-MD5 response for MikroTik
        function computeChapResponse(password) {
            try {
                const chapId = getMikroTikVar('chap-id');
                const chapChallenge = getMikroTikVar('chap-challenge');
                
                console.log('CHAP computation:', { chapId, chapChallenge, password });
                
                if (!chapId || chapId === '$(chap-id)' || !chapChallenge || chapChallenge === '$(chap-challenge)') {
                    console.log('CHAP not in use, using PAP authentication');
                    return null; // CHAP not in use, will use PAP
                }
                
                if (typeof hexMD5 !== 'function') {
                    console.warn('hexMD5 not available, falling back to PAP');
                    return null;
                }
                
                // MikroTik expects 00 + MD5(chap-id + password + chap-challenge)
                const hashInput = chapId + password + chapChallenge;
                const hash = hexMD5(hashInput);
                const response = '00' + hash;
                
                console.log('CHAP response computed:', response);
                return response;
            } catch (e) {
                console.warn('Failed to compute CHAP response', e);
                return null;
            }
        }

        // Get device information
        function getDeviceInfo() {
            return {
                mac: getMikroTikVar('mac'),
                ip: getMikroTikVar('ip'),
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language
            };
        }

        // Fetch organization details
        async function fetchOrganizationDetails() {
            const orgId = getOrgId();
            const apiUrl = `${getApiUrl()}/api/hotspot/organizations/${orgId}`;
            
            console.log('Current page URL:', getCurrentUrl());
            console.log('Fetching organization details from:', apiUrl);
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                console.log('Organization API response status:', response.status);
                console.log('Organization API response headers:', response.headers);

                if (response.ok) {
                    const data = await response.json();
                    console.log('Organization API response data:', data);
                    if (data.organization) {
                        console.log('Organization found, updating branding...');
                        updateOrganizationBranding(data.organization);
                    } else {
                        console.log('No organization data in response');
                    }
                } else {
                    console.error('Organization API error:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                }
            } catch (error) {
                console.error('Failed to fetch organization details:', error);
            }
        }

        // Update organization branding
        function updateOrganizationBranding(org) {
            console.log('Updating organization branding with:', org);
            console.log('Organization business data:', org.business);
            console.log('Organization contact data:', org.contact);
            
            // Update page title
            if (org.name) {
                document.title = `${org.name} - Internet Hotspot`;
                console.log('Updated page title to:', document.title);
            }

            // Update header
            const header = document.querySelector('.header');
            console.log('Header element found:', !!header);
            if (header) {
                const headerLogo = header.querySelector('.header-logo');
                console.log('Header logo element found:', !!headerLogo);
                if (headerLogo) {
                    let logoHtml = '';
                    
                    // Add organization logo if available
                    if (org.business && org.business.logo) {
                        console.log('Adding organization logo:', org.business.logo);
                        console.log('Logo URL protocol:', new URL(org.business.logo).protocol);
                        console.log('Current page protocol:', window.location.protocol);
                        console.log('Current page hostname:', window.location.hostname);
                        
                        // Check if we're on MikroTik hotspot (different hostname)
                        const isMikroTik = window.location.hostname !== 'ispinnacle.co.ke' && window.location.hostname !== 'www.ispinnacle.co.ke';
                        console.log('Is MikroTik hotspot:', isMikroTik);
                        
                        if (isMikroTik) {
                            // For MikroTik hotspot, use fallback logo
                            console.log('Using fallback logo for MikroTik hotspot');
                            logoHtml += `<div style="width: 40px; height: 40px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px;">${org.name ? org.name.charAt(0).toUpperCase() : 'H'}</div>`;
                        } else {
                            // Try to preload the image
                            const img = new Image();
                            img.onload = function() {
                                console.log('Logo preloaded successfully:', this.src);
                            };
                            img.onerror = function() {
                                console.error('Logo preload failed:', this.src);
                            };
                            img.src = org.business.logo;
                            
                            logoHtml += `<img src="${org.business.logo}" alt="${org.name}" style="border: 1px solid red;" crossorigin="anonymous" onload="console.log('Logo loaded successfully:', this.src); this.style.border='1px solid green';" onerror="console.error('Logo failed to load:', this.src); this.style.display='none'; this.nextElementSibling.style.display='block'; console.log('Error details:', this.naturalWidth, this.naturalHeight);">`;
                            logoHtml += `<span style="display:none; color:red; font-size:10px;">Logo failed to load</span>`;
                            
                            // Add a fallback image element without crossorigin
                            logoHtml += `<img src="${org.business.logo}" alt="${org.name}" style="border: 1px solid blue; display: none;" onload="console.log('Fallback logo loaded successfully:', this.src); this.style.border='1px solid green'; this.style.display='block'; this.previousElementSibling.style.display='none';" onerror="console.error('Fallback logo also failed:', this.src);">`;
                        }
                    } else {
                        console.log('No logo available - business:', !!org.business, 'logo:', org.business?.logo);
                        // Add a default logo placeholder
                        logoHtml += `<div style="width: 40px; height: 40px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px;">${org.name ? org.name.charAt(0).toUpperCase() : 'H'}</div>`;
                    }
                    
                    // Add organization name
                    console.log('Adding organization name:', org.name);
                    logoHtml += `<div class="org-name">${org.name || 'ISPinnacle Hotspot'}</div>`;
                    
                    console.log('Header logo HTML:', logoHtml);
                    headerLogo.innerHTML = logoHtml;
                }
            }

            // Update logo area in main content
            const logoArea = document.querySelector('.logo-area');
            console.log('Logo area element found:', !!logoArea);
            if (logoArea) {
                let logoHtml = '';
                
                // Add organization banner if available
                if (org.business && org.business.banner) {
                    console.log('Adding organization banner:', org.business.banner);
                    
                    // Check if we're on MikroTik hotspot
                    const isMikroTik = window.location.hostname !== 'ispinnacle.co.ke' && window.location.hostname !== 'www.ispinnacle.co.ke';
                    
                    if (isMikroTik) {
                        // For MikroTik hotspot, skip banner or use text alternative
                        console.log('Skipping banner for MikroTik hotspot');
                        if (org.name) {
                            logoHtml += `<div style="font-size: 1.5rem; font-weight: bold; color: var(--primary); margin: 20px 0;">${org.name}</div>`;
                        }
                    } else {
                        logoHtml += `<img src="${org.business.banner}" alt="${org.name}" class="org-banner" onerror="console.error('Banner failed to load:', this.src); this.style.display='none';">`;
                    }
                } else {
                    console.log('No banner available - business:', !!org.business, 'banner:', org.business?.banner);
                }
                
                // Add organization description
                if (org.description) {
                    console.log('Adding organization description:', org.description);
                    logoHtml += `<div class="org-description">${org.description}</div>`;
                }
                
                // Add contact information if available
                if (org.contact) {
                    console.log('Adding organization contact info:', org.contact);
                    logoHtml += '<div class="org-contact">';
                    if (org.contact.phone) {
                        logoHtml += `<div class="org-contact-item"><span class="icon">📞</span>${org.contact.phone}</div>`;
                    }
                    if (org.contact.email) {
                        logoHtml += `<div class="org-contact-item"><span class="icon">✉️</span>${org.contact.email}</div>`;
                    }
                    if (org.contact.website) {
                        logoHtml += `<div class="org-contact-item"><span class="icon">🌐</span>${org.contact.website}</div>`;
                    }
                    logoHtml += '</div>';
                }
                
                console.log('Logo area HTML:', logoHtml);
                logoArea.innerHTML = logoHtml;
            }
        }

        // Fetch packages from API with better error handling
        async function fetchPackages() {
            const orgId = getOrgId();
            const apiUrl = `${getApiUrl()}/api/hotspot/packages?organization_id=${orgId}`;
            
            console.log('Fetching packages from:', apiUrl);
            
            try {
                window.packagesLoaded = false;
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    console.error(`API Error: ${response.status} ${response.statusText}`);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Received package data:', data);

                window.packagesLoaded = true;
                if (data && data.packages && data.packages.length > 0) {
                    displayPackages(data.packages);
                } else {
                    useLocalPackages();
                }
            } catch (error) {
                console.error('Fetch error:', error);
                useLocalPackages();
            }
        }

        // Display packages in the UI
        function displayPackages(packages) {
            const container = document.getElementById('packages-container');
            container.innerHTML = '';
            
            packages.forEach(pkg => {
                const card = document.createElement('div');
                card.className = 'package-card';
                card.onclick = () => selectPackage(pkg.id);
                
                let duration = '';
                if (pkg.duration) {
                    // Format duration properly
                    duration = `${pkg.duration} ${formatDurationUnit(pkg.durationUnit, pkg.duration)}`;
                }
                
                let dataLimit = '';
                if (pkg.dataLimit) {
                    // Format data limit properly
                    dataLimit = `${formatDataSize(pkg.dataLimit, pkg.dataLimitUnit)}`;
                }
                
                card.innerHTML = `
                    <h3>${pkg.name}</h3>
                    ${pkg.description ? `<p class="description">${pkg.description}</p>` : ''}
                    <div class="package-details">
                        <p><strong>Speed:</strong> ${pkg.downloadSpeed} Mbps</p>
                        ${duration ? `<p><strong>Duration:</strong> ${duration}</p>` : ''}
                        ${dataLimit ? `<p><strong>Data:</strong> ${dataLimit}</p>` : ''}
                        <p class="price">KES ${pkg.price}</p>
                    </div>
                    <button class="select-btn">Select</button>
                `;
                
                container.appendChild(card);
            });
        }

        // Format duration unit (singular/plural)
        function formatDurationUnit(unit, value) {
            if (value === 1) {
                // Convert plural to singular for value of 1
                if (unit === 'hours') return 'hour';
                if (unit === 'days') return 'day';
                if (unit === 'weeks') return 'week';
                if (unit === 'months') return 'month'; 
            }
            return unit;
        }

        // Format data size with appropriate units
        function formatDataSize(value, unit) {
            if (unit === 'MB' && value >= 1000) {
                return `${(value/1000).toFixed(1)} GB`;
            }
            return `${value} ${unit}`;
        }

        // Normalize Kenyan phone numbers to 2547XXXXXXXX or 2541XXXXXXXX
        function normalizeKenyanPhoneNumber(input) {
            if (!input) return null;
            let digits = String(input).replace(/[^0-9+]/g, '');
            // Strip leading +
            if (digits.startsWith('+')) digits = digits.slice(1);

            // +2547XXXXXXXX or 2547XXXXXXXX
            if (digits.startsWith('254')) {
                if (digits.length === 12) return digits; // 2547XXXXXXXX or 2541XXXXXXXX
                // Sometimes users add extra zeros, trim to last 12 if ends with valid pattern
                if (digits.length > 12 && /^(2547|2541)\d{8}/.test(digits.slice(0,12))) return digits.slice(0,12);
                return null;
            }

            // 07XXXXXXXX or 01XXXXXXXX
            if (digits.startsWith('0') && digits.length === 10 && (/^07\d{8}$/.test(digits) || /^01\d{8}$/.test(digits))) {
                return '254' + digits.slice(1);
            }

            // 7XXXXXXXX or 1XXXXXXXX
            if (digits.length === 9 && (/^7\d{8}$/.test(digits) || /^1\d{8}$/.test(digits))) {
                return '254' + digits;
            }

            return null;
        }

        // Handle package selection
        function selectPackage(packageId) {
            localStorage.setItem('selectedPackageId', packageId);
            document.getElementById('package-selection').style.display = 'none';
            document.getElementById('mpesa-payment').style.display = 'block';
        }

        // Handle voucher purchase with unified payment endpoint
        async function purchaseVoucher() {
            const packageId = localStorage.getItem('selectedPackageId');
            const orgId = getOrgId();
            const phoneInput = document.getElementById('mpesa-phone');
            const phoneNumber = phoneInput.value.trim();
            const normalizedPhone = normalizeKenyanPhoneNumber(phoneNumber);
            const errorDiv = document.getElementById('mpesa-error');
            const loadingDiv = document.getElementById('mpesa-loading');
            errorDiv.textContent = '';
            loadingDiv.style.display = 'block';

            if (!phoneNumber) {
                errorDiv.textContent = 'Please enter your phone number.';
                loadingDiv.style.display = 'none';
                return;
            }

            if (!normalizedPhone) {
                errorDiv.textContent = 'Invalid phone. Use 07XXXXXXXX, 01XXXXXXXX or 2547XXXXXXXX.';
                loadingDiv.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${getApiUrl()}/api/hotspot/purchase-voucher`, {
                    method: 'POST',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Accept': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify({
                        organizationId: orgId,
                        packageId: packageId,
                        phoneNumber: normalizedPhone
                    })
                });
                loadingDiv.style.display = 'none';
                if (!response.ok) {
                    const err = await response.json();
                    errorDiv.textContent = err.detail || err.error || 'Failed to initiate payment.';
                    return;
                }
                const data = await response.json();
                
                // Show payment pending screen
                document.getElementById('mpesa-payment').style.display = 'none';
                document.getElementById('voucher-result').style.display = 'block';
                document.getElementById('voucher-code').textContent = 'Waiting for payment confirmation...';
                
                // Show payment method specific message
                const paymentMethod = data.paymentMethod || 'payment';
                const paymentMethodName = paymentMethod === 'mpesa' ? 'M-Pesa' : 
                                        paymentMethod === 'kopokopo' ? 'KopoKopo' : 'payment';
                document.getElementById('voucher-expiry').textContent = `Please check your phone to complete the ${paymentMethodName} payment.`;
                
                // Start polling for payment status
                pollPaymentStatus(data.voucherId, data.voucherCode);
            } catch (error) {
                loadingDiv.style.display = 'none';
                errorDiv.textContent = 'Network error. Please try again.';
                console.error('Purchase error:', error);
            }
        }

        // Add polling function for payment status
        async function pollPaymentStatus(voucherId, voucherCode) {
            const maxAttempts = 30; // 5 minutes total (10 seconds * 30)
            let attempts = 0;
            
            const poll = async () => {
                try {
                    const response = await fetch(`${getApiUrl()}/api/hotspot/voucher-status/${voucherId}`);
                    const data = await response.json();
                    
                    if (data.voucher && data.voucher.status === 'ACTIVE') {
                        // Payment successful, attempt automatic connection
                        document.getElementById('voucher-code').textContent = voucherCode;
                        document.getElementById('voucher-expiry').textContent = 'Payment successful! Attempting to connect...';
                        
                        // Try automatic connection
                        try {
                            const connectResponse = await fetch(`${getApiUrl()}/api/hotspot/connect`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    voucherCode: voucherCode
                                })
                            });
                            
                            if (connectResponse.ok) {
                                const connectData = await connectResponse.json();
                                // Show remaining duration if available
                                if (connectData.voucher && connectData.voucher.remainingDuration) {
                                    const remaining = connectData.voucher.remainingDuration;
                                    const formatted = formatRemainingDuration(remaining.milliseconds);
                                    document.getElementById('voucher-expiry').textContent = `Remaining time: ${formatted}`;
                                }
                            }
                            
                            if (connectResponse.ok) {
                                // Voucher is valid, submit form to MikroTik
                                const form = document.createElement('form');
                                form.method = 'POST';
                                form.action = '$(link-login-only)';
                                
                                // Build required fields for MikroTik authentication
                                const responseHash = computeChapResponse(voucherCode);
                                const fields = {
                                    'username': voucherCode,
                                    'password': responseHash ? '' : voucherCode,
                                    'response': responseHash || '',
                                    'dst': '$(link-orig)',
                                    'popup': 'true'
                                };
                                
                                // Create and append form fields
                                for (const [name, value] of Object.entries(fields)) {
                                    const input = document.createElement('input');
                                    input.type = 'hidden';
                                    input.name = name;
                                    input.value = value;
                                    form.appendChild(input);
                                }
                                
                                // Add form to document and submit
                                document.body.appendChild(form);
                                form.submit();
                            } else {
                                // Connection failed, show manual connection option
                                document.getElementById('voucher-expiry').textContent = 'Connection failed. Please use the voucher code below to connect manually.';
                                document.getElementById('connect-manually').style.display = 'block';
                            }
                        } catch (error) {
                            console.error('Connection error:', error);
                            document.getElementById('voucher-expiry').textContent = 'Connection failed. Please use the voucher code below to connect manually.';
                            document.getElementById('connect-manually').style.display = 'block';
                        }
                        return;
                    }
                    
                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(poll, 10000); // Poll every 10 seconds
                    } else {
                        document.getElementById('voucher-expiry').textContent = 'Payment confirmation timeout. Please check your phone for the voucher code.';
                        document.getElementById('connect-manually').style.display = 'block';
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                    document.getElementById('voucher-expiry').textContent = 'Error checking payment status. Please use the voucher code below to connect manually.';
                    document.getElementById('connect-manually').style.display = 'block';
                }
            };
            
            poll();
        }

        // Show voucher entry form
        function showVoucherEntry() {
            document.getElementById('package-selection').style.display = 'none';
            document.getElementById('voucher-entry').style.display = 'block';
            
            // Add event listener to check remaining time when voucher code is entered
            const usernameInput = document.querySelector('#voucher-form input[name="username"]');
            if (usernameInput) {
                usernameInput.addEventListener('blur', async function() {
                    const voucherCode = this.value.trim();
                    if (voucherCode && voucherCode.length >= 6) {
                        try {
                            const response = await fetch(`${getApiUrl()}/api/hotspot/connect`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    voucherCode: voucherCode
                                })
                            });
                            
                            if (response.ok) {
                                const connectData = await response.json();
                                if (connectData.voucher && connectData.voucher.remainingDuration) {
                                    const remaining = connectData.voucher.remainingDuration;
                                    const formatted = formatRemainingDuration(remaining.milliseconds);
                                    console.log(`Voucher remaining time: ${formatted}`);
                                    
                                    // Show remaining time in the voucher entry form
                                    const voucherEntryDiv = document.getElementById('voucher-entry');
                                    if (voucherEntryDiv) {
                                        let timeDisplay = voucherEntryDiv.querySelector('.remaining-time');
                                        if (!timeDisplay) {
                                            timeDisplay = document.createElement('div');
                                            timeDisplay.className = 'remaining-time';
                                            timeDisplay.style.cssText = 'margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 5px; text-align: center; font-weight: bold;';
                                            voucherEntryDiv.insertBefore(timeDisplay, voucherEntryDiv.querySelector('form'));
                                        }
                                        timeDisplay.textContent = `Remaining time: ${formatted}`;
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('Error fetching voucher info:', error);
                        }
                    }
                });
            }
        }

        // Handle manual connection with voucher
        async function loginWithVoucher() {
            const voucherCode = document.getElementById('voucher-code').textContent;
            if (voucherCode && voucherCode !== 'Waiting for payment confirmation...') {
                // Pre-fill the voucher form
                document.getElementById('voucher-entry').style.display = 'block';
                document.getElementById('voucher-result').style.display = 'none';
                
                const form = document.getElementById('voucher-form');
                if (form) {
                    form.username.value = voucherCode;
                    form.password.value = voucherCode;
                    
                    // Get updated voucher info to show remaining time
                    try {
                        const response = await fetch(`${getApiUrl()}/api/hotspot/connect`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                voucherCode: voucherCode
                            })
                        });
                        
                        if (response.ok) {
                            const connectData = await response.json();
                            if (connectData.voucher && connectData.voucher.remainingDuration) {
                                const remaining = connectData.voucher.remainingDuration;
                                const formatted = formatRemainingDuration(remaining.milliseconds);
                                console.log(`Voucher remaining time: ${formatted}`);
                                
                                // Show remaining time in the voucher entry form
                                const voucherEntryDiv = document.getElementById('voucher-entry');
                                if (voucherEntryDiv) {
                                    let timeDisplay = voucherEntryDiv.querySelector('.remaining-time');
                                    if (!timeDisplay) {
                                        timeDisplay = document.createElement('div');
                                        timeDisplay.className = 'remaining-time';
                                        timeDisplay.style.cssText = 'margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 5px; text-align: center; font-weight: bold;';
                                        voucherEntryDiv.insertBefore(timeDisplay, voucherEntryDiv.querySelector('form'));
                                    }
                                    timeDisplay.textContent = `Remaining time: ${formatted}`;
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching voucher info:', error);
                    }
                }
            } else {
                showVoucherEntry();
            }
        }

        // Format remaining duration for display
        function formatRemainingDuration(remainingMs) {
            if (!remainingMs || remainingMs <= 0) {
                return 'Expired';
            }
            
            const hours = Math.floor(remainingMs / (60 * 60 * 1000));
            const minutes = Math.floor((remainingMs % (60 * 60 * 1000)) / (60 * 1000));
            const seconds = Math.floor((remainingMs % (60 * 1000)) / 1000);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${seconds}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }

        // Add theme toggle functionality
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const isDark = document.documentElement.classList.contains('dark');
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                themeIcon.textContent = isDark ? '☀️' : '🌙';
            }
        }

        // Fallback to local data if API fails
        function useLocalPackages() {
            console.log('Using local package data');
            window.packagesLoaded = true;
            const localPackages = [
                {
                    id: 'local1',
                    name: '1Hr 10Mbps',
                    description: 'Basic internet access',
                    downloadSpeed: 10,
                    uploadSpeed: 10,
                    duration: 1,
                    durationUnit: 'hours',
                    price: 30
                },
                {
                    id: 'local2',
                    name: 'Daily Package',
                    description: 'High-speed internet access',
                    downloadSpeed: 10,
                    uploadSpeed: 5,
                    duration: 1,
                    durationUnit: 'days',
                    price: 100
                },
                {
                    id: 'local3',
                    name: 'Weekly Package',
                    description: 'Multiple device support',
                    downloadSpeed: 15,
                    uploadSpeed: 8,
                    duration: 7,
                    durationUnit: 'days',
                    dataLimit: 5000,
                    dataLimitUnit: 'MB',
                    price: 500
                }
            ];
            
            displayPackages(localPackages);
        }

        // Handle voucher form submission with MikroTik compliance
        async function handleVoucherSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const username = form.username.value.trim();
            const password = form.password.value.trim();
            
            if (!username || !password) {
                alert('Please enter the voucher code in both fields');
                return;
            }
            
            if (username !== password) {
                alert('Voucher codes do not match');
                return;
            }
            
            // Validate voucher with API first
            try {
                const response = await fetch(`${getApiUrl()}/api/hotspot/connect`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        voucherCode: username
                    })
                });
                
                if (response.ok) {
                    // Voucher is valid, prepare CHAP response for MikroTik
                    const responseHash = computeChapResponse(username);
                    
                    // Update the hidden response field
                    const responseField = document.getElementById('chap-response');
                    if (responseField) {
                        responseField.value = responseHash || '';
                    }
                    
                    // Clear password field if using CHAP
                    if (responseHash) {
                        form.password.value = '';
                    }
                    
                    // Submit the form to MikroTik
                    form.submit();
                } else {
                    const error = await response.json();
                    alert(error.detail || error.error || 'Invalid voucher code. Please check and try again.');
                }
            } catch (error) {
                console.error('Voucher validation error:', error);
                alert('Network error. Please try again.');
            }
        }

        // Initialize the page
        window.onload = function() {
            try {
                // Force cache clearing
                if ('caches' in window) {
                    caches.keys().then(function(names) {
                        for (let name of names) {
                            caches.delete(name);
                        }
                    });
                }
                
                // Clear any stored data that might interfere
                localStorage.removeItem('selectedPackageId');
                sessionStorage.clear();
                
                // Log device information for debugging
                console.log('Device Info:', getDeviceInfo());
                console.log('Is MikroTik Hotspot:', isMikroTikHotspot());
                
                // Set up UI
                const packageSelection = document.getElementById('package-selection');
                const paymentOptions = document.getElementById('mpesa-payment');
                const voucherResult = document.getElementById('voucher-result');
                const voucherEntry = document.getElementById('voucher-entry');
                const haveVoucherBtn = document.getElementById('have-voucher-btn');
                const themeToggle = document.getElementById('theme-toggle');
                
                // Check if elements exist before manipulating them
                if (packageSelection) packageSelection.style.display = 'block';
                if (paymentOptions) paymentOptions.style.display = 'none';
                if (voucherResult) voucherResult.style.display = 'none';
                if (voucherEntry) voucherEntry.style.display = 'none';
                
                // Add event listeners if elements exist
                if (haveVoucherBtn) {
                    haveVoucherBtn.addEventListener('click', showVoucherEntry);
                }
                
                if (themeToggle) {
                    themeToggle.addEventListener('click', toggleTheme);
                }
                
                // Theme initialization
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                }
                if (typeof updateThemeIcon === 'function') {
                    updateThemeIcon();
                }
                
                // Fetch organization details and packages
                fetchOrganizationDetails();
                fetchPackages();
                
                // Add form submit handler
                const voucherForm = document.getElementById('voucher-form');
                if (voucherForm) {
                    voucherForm.addEventListener('submit', handleVoucherSubmit);
                }
                
                // Add keyboard shortcuts
                document.addEventListener('keydown', function(e) {
                    // ESC key to go back
                    if (e.key === 'Escape') {
                        if (voucherEntry && voucherEntry.style.display !== 'none') {
                            document.getElementById('package-selection').style.display = 'block';
                            voucherEntry.style.display = 'none';
                        } else if (paymentOptions && paymentOptions.style.display !== 'none') {
                            packageSelection.style.display = 'block';
                            paymentOptions.style.display = 'none';
                        }
                    }
                });
                
                // Prevent zoom on mobile devices
                document.addEventListener('touchstart', function(e) {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                });
                
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(e) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        e.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
                
            } catch (error) {
                console.error('Error initializing page:', error);
                // Show fallback message
                const main = document.querySelector('.main');
                if (main) {
                    main.innerHTML = `
                        <div class="error-container">
                            <h2>Connection Error</h2>
                            <p>Unable to load hotspot portal. Please try refreshing the page.</p>
                            <button onclick="window.location.reload()" class="primary-btn">Refresh Page</button>
                        </div>
                    `;
                }
            }
        };
    </script>
</head>

<body>
    <!-- Add hidden form for MikroTik variables -->
    <form id="mikrotik-vars-form" style="display: none;">
        <input type="hidden" name="chap-id" value="$(chap-id)" />
        <input type="hidden" name="chap-challenge" value="$(chap-challenge)" />
        <input type="hidden" name="link-orig" value="$(link-orig)" />
        <input type="hidden" name="link-login-only" value="$(link-login-only)" />
        <input type="hidden" name="link-logout" value="$(link-logout)" />
        <input type="hidden" name="mac" value="$(mac)" />
        <input type="hidden" name="ip" value="$(ip)" />
        <input type="hidden" name="username" value="$(username)" />
        <input type="hidden" name="password" value="$(password)" />
        <input type="hidden" name="link-status" value="$(link-status)" />
        <input type="hidden" name="link-logout-only" value="$(link-logout-only)" />
    </form>
    
    <!-- Header with organization logo and theme toggle -->
    <header class="header">
        <div class="header-logo">
            <div class="org-name">ISPinnacle Hotspot</div>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()">
            <span id="theme-icon">🌙</span>
        </button>
    </header>
    
    <div class="ie-fixMinHeight">
        <div class="main">
            <div class="wrap animated fadeIn">
                <div class="logo-area">
                    <div class="logo">ISPinnacle Hotspot</div>
                    <div class="tagline">High-speed internet access</div>
                </div>
                
                <!-- Package Selection Section -->
                <div id="package-selection">
                    <h2>Select an Internet Package</h2>
                    <div id="packages-container">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <p>Loading packages...</p>
                        </div>
                    </div>
                    <p class="info">
                        <button id="have-voucher-btn" class="secondary-btn">
                            <span class="icon">🎟️</span>
                            I already have a voucher
                        </button>
                    </p>
                </div>
                
                <!-- Payment Options Section -->
                <div id="mpesa-payment" style="display: none;">
                    <h2>Complete Payment</h2>
                    <div class="mpesa-form">
                        <div class="form-group">
                            <label for="mpesa-phone">Phone Number:</label>
                            <div class="input-wrapper">
                                <span class="input-icon">📱</span>
                                <input type="tel" id="mpesa-phone" placeholder="e.g. 07XXXXXXXX or 2547XXXXXXXX" maxlength="13" />
                            </div>
                        </div>
                        <button onclick="purchaseVoucher()" class="primary-btn">
                            <span class="icon">💳</span>
                            Pay & Get Voucher
                        </button>
                        <div id="mpesa-loading" class="loading-spinner" style="display:none;">
                            <div class="spinner"></div>
                            <p>Processing payment, please wait...</p>
                        </div>
                        <div id="mpesa-error" class="error-message"></div>
                    </div>
                    <p class="info">
                        <button type="button" class="back-btn" onclick="document.getElementById('package-selection').style.display='block';document.getElementById('mpesa-payment').style.display='none';">
                            <span class="icon">←</span>
                            Back to Packages
                        </button>
                    </p>
                </div>
                
                <!-- Voucher Result Section -->
                <div id="voucher-result" style="display: none;">
                    <h2>Your Voucher</h2>
                    <div class="voucher-details">
                        <div class="voucher-box">
                            <p class="voucher-label">Voucher Code</p>
                            <p class="voucher-code" id="voucher-code">CODE123</p>
                            <p class="voucher-expiry" id="voucher-expiry">2023-12-31</p>
                        </div>
                    </div>
                    <div id="connect-manually" style="display: none;">
                        <button onclick="loginWithVoucher()" class="primary-btn">
                            <span class="icon">🔌</span>
                            Connect Manually
                        </button>
                    </div>
                </div>
                
                <!-- Voucher Entry Section -->
                <div id="voucher-entry" style="display: none;">
                    <h2>Enter Your Voucher</h2>
                    <form id="voucher-form" class="voucher-form" method="POST" action="$(link-login-only)">
                        <div class="form-group">
                            <label>
                                <span class="input-icon">🎟️</span>
                                <input name="username" type="text" placeholder="Voucher Code" required />
                            </label>
                        </div>

                        <div class="form-group">
                            <label>
                                <span class="input-icon">🔑</span>
                                <input name="password" type="password" placeholder="Voucher Code (same as above)" required />
                            </label>
                        </div>

                        <!-- Required MikroTik parameters -->
                        <input type="hidden" name="dst" value="$(link-orig)" />
                        <input type="hidden" name="popup" value="true" />
                        <input type="hidden" name="response" value="" id="chap-response" />

                        <button type="submit" class="primary-btn">
                            <span class="icon">🔌</span>
                            Connect
                        </button>
                        <button type="button" class="back-btn" onclick="document.getElementById('package-selection').style.display='block';document.getElementById('voucher-entry').style.display='none';">
                            <span class="icon">←</span>
                            Back to Packages
                        </button>
                    </form>
                </div>
                
                <p class="info bt">Powered by MikroTik RouterOS</p>
            </div>
        </div>
    </div>
</body>

</html>
